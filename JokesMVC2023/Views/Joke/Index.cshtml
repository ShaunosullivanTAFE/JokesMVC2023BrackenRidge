@model IEnumerable<JokesMVC2023.Models.Data.Joke>

@{
    ViewData["Title"] = "Index";
}

<h1>Index</h1>

<p>
    <a asp-action="Create">Create New</a>
</p>



<input type="button" value="Show Spinner" class="btn btn-primary" onclick="showSpinner()" />

<input type="button" value="Update Table" class="btn btn-outline-light" onclick="startTimer()" />

<input type="button" value="Show Create" class="btn btn-outline-dark" onclick="showCreateModal()" />

<div id="JokeTableContainer">
    <partial name="_JokeTable.cshtml" />
</div>



<div class="modal" id="JokeModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="ModalTitle"></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="ModalBody">
        <p>Modal body text goes here.</p>
      </div>
    </div>
  </div>
</div>

<div class="modal" id="SpinnerModal" tabindex="-1" data-bs-backdrop="false">
  <div class="modal-dialog modal-dialog-centered d-flex justify-content-center">
      <div class="spinner-container">
        <span></span>
        <span></span>
        <span></span>
        <span></span>
      </div>
  </div>
</div>

@Html.AntiForgeryToken();

<script>

    function showSpinner(){
      $('#SpinnerModal').modal('show')
    }

    function hideSpinner(){
      $('#SpinnerModal').modal('hide')
    }

    async function startTimer(){
        setInterval(async (e) => {
            updateTable();
        }, 1000)
    }

    async function updateTable(){
        // Send a GET request to the /Joke/JokeTablePartial endpoint
        let response = await advFetch('/Joke/JokeTablePartial');

        // Parse the results as text
        let htmlResponse = await response.text();

        // overwrite the JokeTableContainer innerHTML with the new data
        document.getElementById('JokeTableContainer').innerHTML = htmlResponse;
    }

    async function deleteConfirm(id){

      // Confirm Dialog
      if(confirm("Are you sure you want to delete Joke with ID: " + id)){
        showSpinner();
        // Fetch Request
        await advFetch('/Joke/Delete?id='+id,{method: "DELETE"})
        // Update Table
        await updateTable();

        hideSpinner();

      }


    }

    async function showEditModal(id){
      showSpinner();
      let response = await advFetch('/Joke/Edit?id='+id);
      let htmlResponse = await response.text();

      document.getElementById('ModalBody').innerHTML = htmlResponse;
      document.getElementById('ModalTitle').innerHTML = "Edit Joke";

      let formReference = document.querySelector('form[action="/Joke/Edit"]');

      console.log(formReference)

      formReference.addEventListener('submit', (e) => { handleEditSubmit(e, id) });
      hideSpinner();
      $('#JokeModal').modal('show');
    }

    async function showCreateModal(){

        let response = await advFetch('/Joke/Create');
        let htmlResponse = await response.text();
        document.getElementById('ModalBody').innerHTML = htmlResponse;
        document.getElementById('ModalTitle').innerHTML = "Create Joke";
        // get a reference to the form

        let formReference = document.querySelector('form[action="/Joke/Create"]');

        // Parse the validation rules on the individual Input fields
        $.validator.unobtrusive.parse(formReference);

        console.log(formReference);

        formReference.addEventListener("submit", (e) => { handleCreateSubmit(e) });

        $('#JokeModal').modal('show');
    }

    async function handleEditSubmit(e, id){
        e.preventDefault();

        let form = e.target;

        let jokeData = {
          id: id,
          jokeQuestion: form["JokeQuestion"].value,
          jokeAnswer: form["JokeAnswer"].value
        };

        let response = await advFetch('/Joke/Edit?id='+id, {
          method: 'PUT',
          headers: {
            'content-type': 'application/json'
          },
          body: JSON.stringify(jokeData)
        });

        updateTable();

        $('#JokeModal').modal('hide');

    }

    async function handleCreateSubmit(e) {
        e.preventDefault();

        let form = $(e.target);
        if(!form.valid()){
          return;
        }

        let button = document.getElementById('btnCreate');

        button.setAttribute('disabled', 'disabled');
        button.innerHTML = `                    
          <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
          Loading...
          `;


        // Extract a JSON object





        let jokeData = {
            jokeQuestion: e.target["JokeQuestion"].value,
            jokeAnswer: e.target["JokeAnswer"].value
        };



        // POST the joke to the controller
        let response = await advFetch('/Joke/Create', {
            method: "POST",
            headers: {
                'content-type': 'application/json'
            },
            body: JSON.stringify(jokeData)
        });

        if(response.ok){
          console.log(jokeData);

          updateTable();

          $('#JokeModal').modal('hide');

          if(response.status == 201){
            let joke = await response.json();
            console.log(joke.id);
            localStorage.setItem('JokeID', joke.id);
          }
        }

          button.removeAttribute('disabled');
          button.innerHTML = 'Create';
       


    }

</script>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
}